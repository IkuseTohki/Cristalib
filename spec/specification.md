# 蔵書管理アプリケーション仕様書

## 1. 目的

ZIP 圧縮された漫画ファイルを管理し、快適な蔵書管理環境を提供することを目的とする。

## 2. 機能要件

### 2.1. 蔵書データの登録と同期

- データベースに登録されたスキャン対象フォルダ内を再帰的に検索し、ライブラリの状態を実ファイルと同期する。
- データベースに登録された除外フォルダは、検索対象から除外する。
- 同期処理では、ファイルのハッシュ値を用いて以下の状態を認識し、適切に処理する。
  - **新規ファイル:** DB に存在しないハッシュ値のファイルを検知した場合、新規データとして登録処理を行う。
  - **ファイル移動:** DB にハッシュ値は存在するがパスが異なるファイルを検知した場合、ファイルの移動と判断し、DB のパス情報を更新する。
  - **ファイル更新:** パスは同じだがハッシュ値が異なるファイルを検知した場合、ファイルの更新と判断し、DB のハッシュ値を更新する。
  - **ファイル削除:** DB に記録されているファイルがスキャン時に見つからなかった場合、ファイルが削除されたものとして扱う（例: 不明なファイルとしてマークする）。
- アプリケーションの表示モード（通常/プライベート）に応じて、表示・検索される蔵書データが切り替わる。
  - **通常モード時:** プライベート設定でないフォルダの蔵書のみを対象とする。サブフォルダ内の書籍も、その最上位のスキャンフォルダのプライベート属性に従う。
  - **プライベートモード時:** すべての蔵書を対象とする。

### 2.2. ファイル名からの情報抽出

- 登録時に、ファイル名から書籍名・巻数・著者名などを自動で読み取って入力する。
- ファイル名の解析ルールは、外部の設定ファイル(`parsing_rules.json`)で定義・管理できるものとし、複数の命名規則パターンに対応する。
  - 詳細は「4.1. ファイル名解析ルール (`parsing_rules.json`)」を参照。

### 2.3. 手動での情報編集

- テーブルで選択した書籍の詳細情報を編集ダイアログで手動で入力・編集できる。
- 編集可能な項目:
  - タイトル、サブタイトル、巻数、著者、原作者、シリーズ、カテゴリ、評価、雑誌版

### 2.4. 検索・並び替え

- テーブル表示された蔵書リストに対し、キーワード検索と並び替えが可能。
- **検索:** 書籍名、サブタイトル、著者名、原作者名、カテゴリ、シリーズ名などで蔵書を検索できる。
- **並び替え:** テーブルのヘッダーをクリックすることで、各列を基準に昇順/降順で並び替えできる。

### 2.5. ビューア連携

- テーブルで選択した ZIP ファイルを、設定された外部ビューアで開く。
- 外部ビューアが設定されていない場合、または見つからない場合は、その旨をユーザーに通知する。

### 2.6. プライベートモード

- アプリケーションに「通常モード」と「プライベートモード」の 2 つの状態を設ける。アプリケーションの起動時は常に「通常モード」とする。
- メイン画面にモード切替ボタンを配置し、パスワード認証に成功すると「プライベートモード」に移行する。
- プライベートモード中は、ボタン操作によりパスワードなしで「通常モード」に戻ることができる。
- モードの状態はアプリケーションを終了するまで維持される。

### 2.7. 設定機能

- アプリケーションにパスワードで保護された設定画面を設ける。この画面では、アプリケーションの永続的な設定を行う。
- **パスワード認証:** 設定画面を開く際には、パスワード入力を要求する。パスワードが未設定の場合は、初回設定を促す。
- **フォルダ管理:**
  - スキャン対象フォルダのパスを追加・削除できる。
  - 各スキャン対象フォルダに「プライベート」属性を設定できる（チェックボックス）。
  - スキャンから除外するフォルダのパスを追加・削除できる。
- **セキュリティ設定:**
  - 設定画面に入るためのパスワードを設定・変更できる。
- **ビューア設定:**
  - 蔵書を開く際に使用する、外部ビューアの実行ファイルのパスを設定できる。

### 2.8. UI のカスタマイズと永続化

- テーブルの各列の表示/非表示をメニューから切り替えられる。
- 列の表示/非表示設定および列幅は、アプリケーション終了後も保持される。
- アプリケーション全体のフォントサイズを設定できる。

## 3. データモデル

データベース（SQLite）に保存するデータ項目は以下の通りとする。

### 3.1. 蔵書テーブル (`books`)

| カラム名                 | データ型 | 説明                                               |
| :----------------------- | :------- | :------------------------------------------------- |
| `id`                     | INTEGER  | 主キー（自動採番）                                 |
| `title`                  | TEXT     | 書籍のタイトル                                     |
| `subtitle`               | TEXT     | サブタイトル                                       |
| `volume`                 | INTEGER  | 巻数                                               |
| `author`                 | TEXT     | 著者名                                             |
| `original_author`        | TEXT     | 原作者名                                           |
| `series`                 | TEXT     | シリーズ名                                         |
| `category`               | TEXT     | カテゴリ/ジャンル                                  |
| `rating`                 | INTEGER  | 評価（0〜5）                                       |
| `is_magazine_collection` | INTEGER  | 雑誌版かどうかのフラグ (0: False, 1: True)         |
| `file_path`              | TEXT     | ZIP ファイルの絶対パス                             |
| `file_hash`              | TEXT     | ファイルのハッシュ値。ファイルの同一性識別に利用。 |
| `created_at`             | TEXT     | 登録日時 (ISO 8601 形式)                           |

### 3.2. スキャン対象フォルダテーブル (`scan_folders`)

| カラム名     | データ型 | 説明                                                     |
| :----------- | :------- | :------------------------------------------------------- |
| `id`         | INTEGER  | 主キー（自動採番）                                       |
| `path`       | TEXT     | フォルダの絶対パス                                       |
| `is_private` | INTEGER  | プライベートフォルダかどうかのフラグ (0: False, 1: True) |

### 3.3. 除外フォルダテーブル (`exclude_folders`)

| カラム名 | データ型 | 説明               |
| :------- | :------- | :----------------- |
| `id`     | INTEGER  | 主キー（自動採番） |
| `path`   | TEXT     | フォルダの絶対パス |

### 3.4. アプリケーション設定テーブル (`app_settings`)

| カラム名 | データ型 | 説明                                             |
| :------- | :------- | :----------------------------------------------- |
| `key`    | TEXT     | 設定項目名（例: 'password_hash', 'viewer_path'） |
| `value`  | TEXT     | 設定値                                           |

## 4. 外部設定ファイル

### 4.1. ファイル名解析ルール (`parsing_rules.json`)

ファイル名の解析ルールを定義する外部設定ファイル。
アプリケーションは起動時にこのファイルを読み込み、ファイル名からの情報抽出に利用する。

- **ファイル形式:** JSON
- **内容:** ファイル名の命名規則を正規表現で定義するルールのリスト。各ルールは、以下のキーを持つオブジェクトで構成されます。
  - `name` (文字列, 必須): ルールの分かりやすい名前。
  - `regex` (文字列, 必須): 情報抽出のための正規表現。Python の `re` モジュールが使用されます。**名前付きキャプチャグループ `(?P<key>...)`** を使用して、抽出したい情報を定義します。
  - `priority` (整数, 必須): ルールを適用する優先順位。数値が小さいほど優先度が高く、先に試されます。

#### 定義済みキーワード

`regex` の名前付きキャプチャグループ (`?P<key>`) で使用できるキーと、対応するデータベースの項目は以下の通りです。

| キーワード        | 対応する書籍情報フィールド (`Book` クラス) | 説明                                                                                                    |
| :---------------- | :----------------------------------------- | :------------------------------------------------------------------------------------------------------ |
| `title`           | `book.title`                               | 書籍のメインタイトル                                                                                    |
| `subtitle`        | `book.subtitle`                            | サブタイトル                                                                                            |
| `volume`          | `book.volume`                              | 巻数（半角数字として抽出されます）                                                                      |
| `author`          | `book.author`                              | 著者名（作画者）                                                                                        |
| `original_author` | `book.original_author`                     | 原作者名                                                                                                |
| `series`          | `book.series`                              | シリーズ名                                                                                              |
| `category`        | `book.category`                            | カテゴリ/ジャンル                                                                                       |
| `rating`          | `book.rating`                              | 評価（半角数字として抽出されます）                                                                      |
| `magazine_flag`   | `book.is_magazine_collection`              | このキーワードがマッチした場合、`is_magazine_collection` が `True` に設定されます。値は抽出されません。 |

#### 記述例

```json
[
  {
    "name": "[著者] タイトル 第N巻 (雑誌版対応)",
    "regex": "\\[(?P<author>.+?)\\]\\s*(?P<title>.+?)\\s*第(?P<volume>\\d+)巻(?P<magazine_flag>\\s*\\(雑誌寄せ集め\\))?.*",
    "priority": 1
  },
  {
    "name": "タイトル N巻 (著者) (雑誌版対応)",
    "regex": "(?P<title>.+?)\\s*(?P<volume>\\d+)\\s*\\((?P<author>.+?)\\)(?P<magazine_flag>\\s*\\(雑誌寄せ集め\\))?.*",
    "priority": 2
  }
]
```
