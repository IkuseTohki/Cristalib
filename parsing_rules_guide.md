# `parsing_rules.json` の書き方ガイド

このドキュメントでは、Cristalib アプリケーションがファイル名から書籍情報を自動抽出するために使用する `parsing_rules.json` ファイルの記述方法について説明します。

## 1. 目的

`parsing_rules.json` は、書籍ファイルのファイル名から「タイトル」「著者」「巻数」などの情報を自動的に解析するためのルールを定義します。これにより、手動でのデータ入力の手間を省き、効率的な蔵書管理を可能にします。

## 2. ファイル形式と構造

`parsing_rules.json` は JSON 形式のファイルで、複数のルールオブジェクトを要素とする配列（リスト）として記述します。

```json
[
  {
    "name": "ルール1の分かりやすい名前",
    "regex": "正規表現パターン",
    "priority": 1
  },
  {
    "name": "ルール2の分かりやすい名前",
    "regex": "別の正規表現パターン",
    "priority": 2
  }
]
```

### 各ルールの要素

- `name` (文字列, 必須):
  このルールの分かりやすい名前です。デバッグや管理の際に役立ちます。

- `regex` (文字列, 必須):
  ファイル名から情報を抽出するための正規表現パターンです。Python の `re` モジュールが使用されます。後述の「定義済みキーワード」をキーとする**名前付きキャプチャグループ `(?P<key>...)`** を使用して、抽出したい情報を指定します。

- `priority` (整数, 必須):
  このルールの適用優先順位です。数値が小さいほど優先度が高く、ファイル名解析時に先に試されます。複数のルールがファイル名にマッチする場合、最も優先度の高いルールが適用されます。

## 3. `regex` パターンと定義済みキーワード

`regex` パターン内で使用できる名前付きキャプチャグループのキーワードと、それに対応する書籍情報フィールドは以下の通りです。

| キーワード        | 対応する書籍情報フィールド (`Book` クラス) | 説明                                                                                                    |
| :---------------- | :----------------------------------------- | :------------------------------------------------------------------------------------------------------ |
| `title`           | `book.title`                               | 書籍のメインタイトル                                                                                    |
| `subtitle`        | `book.subtitle`                            | サブタイトル                                                                                            |
| `volume`          | `book.volume`                              | 巻数（半角数字として抽出されます）                                                                      |
| `author`          | `book.author`                              | 著者名（作画者）                                                                                        |
| `original_author` | `book.original_author`                     | 原作者名                                                                                                |
| `series`          | `book.series`                              | シリーズ名                                                                                              |
| `category`        | `book.category`                            | カテゴリ/ジャンル                                                                                       |
| `rating`          | `book.rating`                              | 評価（半角数字として抽出されます）                                                                      |
| `magazine_flag`   | `book.is_magazine_collection`              | このキーワードがマッチした場合、`is_magazine_collection` が `True` に設定されます。値は抽出されません。 |

**注意:** `regex` パターン内のバックスラッシュ (`\`) は、JSON 文字列として記述する際に `\\` のように二重にエスケープする必要があります。

## 4. 記述例

以下は、一般的なファイル名の命名規則に対応するための `parsing_rules.json` の記述例です。

```json
[
  {
    "name": "[著者] タイトル 第N巻 (雑誌版対応)",
    "regex": "\\[(?P<author>.+?)\\]\\s*(?P<title>.+?)\\s*第(?P<volume>\\d+)巻(?P<magazine_flag>\\s*\\(雑誌寄せ集め\\))?.*",
    "priority": 1
  },
  {
    "name": "タイトル N巻 (著者) (雑誌版対応)",
    "regex": "(?P<title>.+?)\\s*(?P<volume>\\d+)\\s*\\((?P<author>.+?)\\)(?P<magazine_flag>\\s*\\(雑誌寄せ集め\\))?.*",
    "priority": 2
  },
  {
    "name": "タイトル (シリーズ) N巻",
    "regex": "(?P<title>.+?)\\s*\\((?P<series>.+?)\\)\\s*(?P<volume>\\d+).*",
    "priority": 3
  },
  {
    "name": "タイトル (著者)",
    "regex": "(?P<title>.+?)\\s*\\((?P<author>.+?)\\).*",
    "priority": 4
  }
]
```

### 例の解説

- **ルール 1 (`priority: 1`):**

  - `[著者] タイトル 第N巻 (雑誌寄せ集め)` のような形式に対応します。
  - `(?P<author>.+?)` で `著者` を、`(?P<title>.+?)` で `タイトル` を、`(?P<volume>\d+)` で `巻数` を抽出します。
  - `(?P<magazine_flag>\s*\(雑誌寄せ集め\))?` がマッチすると `is_magazine_collection` が `True` になります。

- **ルール 2 (`priority: 2`):**

  - `タイトル N (著者) (雑誌寄せ集め)` のような形式に対応します。

- **ルール 3 (`priority: 3`):**

  - `タイトル (シリーズ) N` のような形式に対応します。

- **ルール 4 (`priority: 4`):**
  - `タイトル (著者)` のようなシンプルな形式に対応します。

これらのルールは優先度順に適用され、最初にマッチしたルールが使用されます。より具体的なルールを高い優先度（小さい数値）に設定することで、正確な情報抽出が期待できます。

---
